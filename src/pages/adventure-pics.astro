---
import Layout from "../layouts/Layout.astro";
import Main from "../components/Main.astro";
import fs from "fs";
import path from "path";

// Get all image files from the adventure-pics directory
let images: string[] = [];
try {
  const adventurePicsPath = path.join(
    process.cwd(),
    "public",
    "adventure-pics"
  );
  if (fs.existsSync(adventurePicsPath)) {
    const files = fs.readdirSync(adventurePicsPath);
    images = files.filter((file) => /\.(jpg|jpeg|png|gif|webp)$/i.test(file));

    // Fisher-Yates Shuffle
    for (let i = images.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [images[i], images[j]] = [images[j], images[i]];
    }
  }
} catch (error) {
  console.log("Could not read adventure-pics directory:", error);
}
---

<Layout title="Adventures">
  <Main>
    <div class="gallery-header">
      <p>The greatest joy of magic lies in searching for it.</p>
    </div>

    <div class="gallery-container">
      <div class="photo-gallery">
        {
          images.length === 0 ? (
            <div class="empty-gallery">
              <p>
                No photos yet! Add some adventure photos to the{" "}
                <code>/public/adventure-pics/</code> folder.
              </p>
            </div>
          ) : (
            images.map((filename, index) => {
              const imagePath = `/adventure-pics/${filename}`;
              return (
                <div
                  class={`photo-item photo-${(index % 10) + 1}`}
                  data-lightbox="gallery"
                  data-src={imagePath}
                >
                  <img
                    src={imagePath}
                    alt={`Adventure photo ${index + 1}`}
                    loading="lazy"
                  />
                </div>
              );
            })
          )
        }
      </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="lightbox">
      <div class="lightbox-content">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-image" src="" alt="" />
      </div>
    </div>
  </Main>
</Layout>

<style>
  :global(.main-content) {
    width: 100%;
    max-width: 1200px;
    align-items: center;
    box-sizing: border-box;
  }

  .gallery-container {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .gallery-header {
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .gallery-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    color: var(--accent-dark);
  }

  .gallery-header p {
    font-style: italic;
    color: #666;
    margin-bottom: 0;
  }

  .empty-gallery {
    text-align: center;
    padding: 3rem;
    background: var(--accent-lighter);
    border-radius: 1rem;
    margin: 2rem 0;
  }

  .empty-gallery code {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 0.3rem;
    font-family: "Courier New", monospace;
  }

  .photo-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    grid-auto-rows: 180px;
    grid-auto-flow: dense;
    gap: 1rem;
    padding: 1rem;
    padding-bottom: 3rem;
    max-width: 1200px;
    width: 100%;
    box-sizing: border-box;
  }

  .photo-item {
    position: relative;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
    background: var(--accent-lighter);
    cursor: pointer;
  }

  .photo-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
  }

  .photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Grid spanning variations */
  .photo-1 {
    grid-column: span 2;
    grid-row: span 1;
  }

  .photo-2 {
    /* Square */
  }

  .photo-3 {
    /* Square */
  }

  .photo-4 {
    /* Square */
  }

  .photo-5 {
    /* Square */
  }

  .photo-6 {
    /* Square */
  }

  .photo-7 {
    grid-column: span 1;
    grid-row: span 2;
  }

  .photo-8 {
    grid-column: span 2;
    grid-row: span 2;
  }

  .photo-9 {
    /* Square */
  }

  .photo-10 {
    /* Square */
  }

  /* Varied image sizing */
  .photo-vertical {
    grid-row: span 2 !important;
    grid-column: span 1 !important;
  }

  .photo-vertical-small {
    grid-row: span 1 !important;
    grid-column: span 1 !important;
  }

  .photo-wide {
    grid-column: span 2 !important;
    grid-row: span 1 !important;
  }

  .photo-large {
    grid-column: span 2 !important;
    grid-row: span 2 !important;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .photo-gallery {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      grid-auto-rows: 150px;
      gap: 0.75rem;
    }

    .photo-1,
    .photo-3,
    .photo-5,
    .photo-wide,
    .photo-large {
      grid-column: span 1 !important;
    }

    .photo-large,
    .photo-vertical {
      grid-row: span 1 !important;
    }

    .gallery-header h1 {
      font-size: 2rem;
    }
  }

  @media (max-width: 635px) {
    .photo-gallery {
      grid-template-columns: 1fr 1fr !important;
      gap: 0.5rem !important;
      padding: 0.5rem !important;
    }

    .photo-item {
      border-radius: 0.5rem !important;
      transform: none !important;
    }

    .photo-1, .photo-3, .photo-5, .photo-8, .photo-10 {
      grid-column: span 2 !important;
      transform: none !important;
    }

    .photo-2, .photo-4, .photo-6, .photo-9 {
      grid-column: span 1 !important;
      transform: none !important;
    }

    .photo-7 {
      grid-row: span 2 !important;
      grid-column: span 1 !important;
    }
  }

  /* Lightbox Styles */
  .lightbox {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
  }

  .lightbox-content {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    padding: 2rem;
    box-sizing: border-box;
  }

  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    z-index: 1001;
    transition: opacity 0.3s ease;
  }

  .lightbox-close:hover {
    opacity: 0.7;
  }

  #lightbox-image {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    border-radius: 0.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  }

  @media (max-width: 768px) {
    .lightbox-content {
      padding: 1rem;
    }

    .lightbox-close {
      font-size: 1.5rem;
      top: 0.5rem;
      right: 1rem;
    }

    #lightbox-image {
      max-width: 95%;
      max-height: 85%;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const lightbox = document.getElementById("lightbox");
    const lightboxImage = document.getElementById("lightbox-image");
    const lightboxClose = document.querySelector(".lightbox-close");
    const photoItems = document.querySelectorAll('[data-lightbox="gallery"]');

    // Analyze all images first, then apply varied layout
    let imagesAnalyzed = 0;
    const imageData = [];

    photoItems.forEach((item, index) => {
      const img = item.querySelector("img");

      function analyzeImage() {
        const isVertical = img.naturalHeight > img.naturalWidth * 1.2;
        const isWide = img.naturalWidth > img.naturalHeight * 1.4;

        imageData.push({
          item: item,
          index: index,
          isVertical: isVertical,
          isWide: isWide,
          aspectRatio: img.naturalWidth / img.naturalHeight,
        });

        imagesAnalyzed++;

        // When all images are analyzed, apply smart layout
        if (imagesAnalyzed === photoItems.length) {
          applySmartLayout();
        }
      }

      img.addEventListener("load", analyzeImage);

      // Handle already loaded images
      if (img.complete && img.naturalHeight > 0) {
        analyzeImage();
      }
    });

    function applySmartLayout() {
      imageData.forEach((imgData, i) => {
        const item = imgData.item;
        
        // Pseudo-random seed based on index and a shift
        const rand = (imgData.index * 13) % 17;

        if (imgData.isVertical) {
          // Vertical images mostly square (cropped), occasionally span 2 rows
          // Reduced frequency: only if rand % 5 == 0 (20% chance)
          // previously was rand % 3 == 0 (33% chance)
          if (rand % 5 === 0) {
            item.classList.add("photo-vertical");
          } else {
            item.classList.add("photo-vertical-small");
          }
        } else if (imgData.isWide) {
          // Wide images mostly square (cropped), occasionally span 2 columns
          // Added randomness: only if rand % 5 == 0 (20% chance)
          // previously was always applied
          if (rand % 5 === 0) {
            item.classList.add("photo-wide");
          }
        } else if (imgData.aspectRatio > 0.9 && imgData.aspectRatio < 1.1) {
          // Square-ish images occasionally become large (2x2)
          // Reduced frequency: rand % 8 == 0 (12.5% chance)
          if (rand % 8 === 0) {
            item.classList.add("photo-large");
          }
        }
      });
    }

    // Open lightbox when photo is clicked
    photoItems.forEach((item) => {
      item.addEventListener("click", function () {
        openLightbox(this.dataset.src);
      });
    });

    // Close lightbox
    lightboxClose.addEventListener("click", closeLightbox);
    lightbox.addEventListener("click", function (e) {
      if (
        e.target === lightbox ||
        e.target.classList.contains("lightbox-content")
      ) {
        closeLightbox();
      }
    });

    // Keyboard navigation
    document.addEventListener("keydown", function (e) {
      if (lightbox.style.display === "block" && e.key === "Escape") {
        closeLightbox();
      }
    });

    function openLightbox(imageSrc) {
      lightboxImage.src = imageSrc;
      lightbox.style.display = "block";
      document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
      lightbox.style.display = "none";
      document.body.style.overflow = "auto";
    }
  });
</script>
